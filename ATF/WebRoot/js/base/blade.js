jQuery.bladeIcons = {
	'closeIcon' : '<svg viewBox="0 0 16 16"><g><path d="M14 3.3L12.7 2 8 6.7 3.3 2 2 3.3 6.7 8 2 12.7 3.3 14 8 9.3l4.7 4.7 1.3-1.3L9.3 8z"></path></g></svg>',
	'refreshIcon' : '<svg viewBox="0 0 16 16">\t<path d="M0 0h7v7z M7.7 16C3.5 15.9 0 12.4 0 8.2c0-2.5 1.2-4.7 3-6.1l1.7 1.7c-1.5.9-2.4 2.5-2.4 4.4 0 3 2.4 5.4 5.4 5.5 3 0 5.4-2.3 5.4-5.3 0-1.9-1-3.6-2.4-4.6l1.6-1.6c1.9 1.4 3 3.8 3 6.3-.1 4.2-3.4 7.6-7.6 7.5z"></path></svg>',
	'minIcon' : '<svg viewBox="0 0 16 16"><g><path d="M2 12h12v2H2z"></path></g></svg>',
	'restoreIcon' : '<svg viewBox="0 0 16 16"><g><path d="M1 2v12h14V2H1zm2 10V6h10v6H3z"></path></g></svg>',
	'maxIcon' : '<svg viewBox="0 0 16 16"><g><path d="M11 5H2v9h9V5zm-7 7V7h5v5H4z"></path><path d="M8 6V3h5v5h-3v2h5V1H6v5h2z"></path></g></svg>',

	'addIcon' : '<svg viewBox="0 0 16 16">\t<path d="M15.9 10H0V6h16v4z M10 16H6V0h4v15.9z"></path></svg>',
	'refreshIcon' : '<svg viewBox="0 0 16 16">\t<path d="M0 0h7v7z M7.7 16C3.5 15.9 0 12.4 0 8.2c0-2.5 1.2-4.7 3-6.1l1.7 1.7c-1.5.9-2.4 2.5-2.4 4.4 0 3 2.4 5.4 5.4 5.5 3 0 5.4-2.3 5.4-5.3 0-1.9-1-3.6-2.4-4.6l1.6-1.6c1.9 1.4 3 3.8 3 6.3-.1 4.2-3.4 7.6-7.6 7.5z"></path></svg>',
	'editIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path d="M 48,30L 55.75,30L 48,22.25L 48,30 Z M 57,33L 44,33L 44,21L 29,21L 29,31.25L 25,27.25L 25,17L 48.25,17L 61,29.75L 61,59L 25,59L 25,41.75L 29,45.75L 29,55L 57,55L 57,33 Z M 24.5417,28.5L 39.5833,43.5417L 34.0417,49.0833L 19,34.0417L 24.5417,28.5 Z M 17.8125,32.8542L 14.6458,30.314C 13.6303,29.2984 14.0262,27.1405 15.0417,26.125L 16.625,24.5417C 17.6405,23.5262 19.5678,23.1303 20.5833,24.1459L 23.3541,27.3126L 17.8125,32.8542 Z M 41.9715,52.25L 35.2292,50.2709L 40.7708,44.7292L 42.6216,51.5999L 41.9715,52.25 Z "></path></svg>',
	'deleteIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path d="M 25.3333,23.75L 50.6667,23.75C 51.5411,23.75 51.8541,27.3125 51.8541,27.3125L 24.1458,27.3125C 24.1458,27.3125 24.4589,23.75 25.3333,23.75 Z M 35.625,19.7917L 40.375,19.7917C 40.8122,19.7917 41.9583,20.9378 41.9583,21.375C 41.9583,21.8122 40.8122,22.9584 40.375,22.9584L 35.625,22.9584C 35.1878,22.9584 34.0416,21.8122 34.0416,21.375C 34.0416,20.9378 35.1878,19.7917 35.625,19.7917 Z M 27.7083,28.5L 48.2916,28.5C 49.1661,28.5 49.875,29.2089 49.875,30.0834L 48.2916,53.8334C 48.2916,54.7078 47.5828,55.4167 46.7083,55.4167L 29.2917,55.4167C 28.4172,55.4167 27.7083,54.7078 27.7083,53.8334L 26.125,30.0834C 26.125,29.2089 26.8339,28.5 27.7083,28.5 Z M 30.0833,31.6667L 30.4792,52.25L 33.25,52.25L 32.8542,31.6667L 30.0833,31.6667 Z M 36.4167,31.6667L 36.4167,52.25L 39.5833,52.25L 39.5833,31.6667L 36.4167,31.6667 Z M 43.1458,31.6667L 42.75,52.25L 45.5208,52.25L 45.9167,31.6667L 43.1458,31.6667 Z "></path></svg>',
	'importIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path d="M 35,13L 35,30.5L 27,21L 27,30.75L 38,43.25L 49,30.75L 49,21L 41,30.5L 41,13L 35,13 Z M 17,38L 30,38L 33.75,42L 21,42L 21,53L 55,53L 55,42L 42.25,42L 46,38L 59,38L 59,57L 17,57L 17,38 Z M 33,46L 43,46L 43,49L 33,49L 33,46 Z "></path></svg>',
	'exportIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path d="M 35,43L 35,25.5L 27,35L 27,25.25L 38,12.75L 49,25.25L 49,35L 41,25.5L 41,43L 35,43 Z M 17,38L 33,38L 33,42L 21,42L 21,53L 55,53L 55,42L 43,42L 43,38L 59,38L 59,57L 17,57L 17,38 Z M 33,46L 43,46L 43,49L 33,49L 33,46 Z"></path></svg>',
	'saveIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path d="M 20.5833,20.5833L 55.4167,20.5833L 55.4167,55.4167L 45.9167,55.4167L 45.9167,44.3333L 30.0833,44.3333L 30.0833,55.4167L 20.5833,55.4167L 20.5833,20.5833 Z M 33.25,55.4167L 33.25,50.6667L 39.5833,50.6667L 39.5833,55.4167L 33.25,55.4167 Z M 26.9167,23.75L 26.9167,33.25L 49.0833,33.25L 49.0833,23.75L 26.9167,23.75 Z"></path></svg>',
	'previewIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 38,33.1538C 40.6765,33.1538 42.8462,35.3235 42.8462,38C 42.8462,40.6765 40.6765,42.8461 38,42.8461C 35.3235,42.8461 33.1539,40.6765 33.1539,38C 33.1539,35.3235 35.3236,33.1538 38,33.1538 Z M 38,25.0769C 49.3077,25.0769 59,33.1538 59,38C 59,42.8461 49.3077,50.9231 38,50.9231C 26.6923,50.9231 17,42.8461 17,38C 17,33.1538 26.6923,25.0769 38,25.0769 Z M 38,29.1154C 33.0932,29.1154 29.1154,33.0932 29.1154,38C 29.1154,42.9068 33.0932,46.8846 38,46.8846C 42.9068,46.8846 46.8846,42.9068 46.8846,38C 46.8846,33.0932 42.9068,29.1154 38,29.1154 Z "/></svg>',
	'codeIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 36.4167,44.3333L 14.0811,34.1365L 14.0811,30.2522L 36.4167,19.57L 36.4167,25.2601L 20.3933,32.0731L 20.3933,32.2172L 36.4167,38.6356L 36.4167,44.3333 Z M 61.9189,46.2333L 39.5833,56.43L 39.5833,50.7551L 55.6067,44.367L 55.6067,44.2683L 39.5833,37.3871L 39.5833,31.6667L 61.9189,42.3489L 61.9189,46.2333 Z "/></svg>',
	'runIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 30.0833,22.1667L 50.6665,37.6043L 50.6665,38.7918L 30.0833,53.8333L 30.0833,22.1667 Z"/></svg>',
	'scheduleIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 38,23.75C 46.7445,23.75 53.8333,30.8388 53.8333,39.5833C 53.8333,48.3278 46.7445,55.4167 38,55.4167C 29.2555,55.4167 22.1667,48.3278 22.1667,39.5833C 22.1667,30.8388 29.2555,23.75 38,23.75 Z M 38,27.7083C 31.4416,27.7083 26.125,33.025 26.125,39.5833C 26.125,46.1417 31.4416,51.4583 38,51.4583C 44.5584,51.4583 49.875,46.1417 49.875,39.5833C 49.875,33.025 44.5584,27.7083 38,27.7083 Z M 37.6042,30.875C 38.4786,30.875 39.1875,31.5839 39.1875,32.4583L 39.1875,38.3959L 45.125,38.3959C 45.9994,38.3959 46.7083,39.1047 46.7083,39.9792L 46.7083,40.7708C 46.7083,41.6453 45.9994,42.3542 45.125,42.3542L 38,42.3542C 37.2083,42.2222 36.4167,42.0903 35.9548,41.6285C 35.493,41.1667 35.3611,40.375 35.2292,39.5833L 35.2292,32.4583C 35.2292,31.5839 35.938,30.875 36.8125,30.875L 37.6042,30.875 Z M 49.0833,20.5833C 52.5811,20.5833 55.4167,23.4189 55.4167,26.9167C 55.4167,28.4256 54.889,29.8113 54.008,30.8993C 51.9429,27.1006 48.5651,24.1189 44.4835,22.5632C 45.6379,21.3439 47.2718,20.5833 49.0833,20.5833 Z M 26.9167,20.5834C 28.7282,20.5834 30.3621,21.3439 31.5165,22.5632C 27.4349,24.1189 24.0571,27.1006 21.992,30.8993C 21.111,29.8113 20.5833,28.4256 20.5833,26.9167C 20.5833,23.4189 23.4189,20.5834 26.9167,20.5834 Z"/></svg>',
	'duplicateIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 27,20L 38.75,20L 37.75,19L 24,19L 24,50L 27,50L 27,20 Z M 46.25,20L 59,32.75L 59,59L 27,59L 27,54L 20,54L 20,15L 39.25,15L 44.25,20L 46.25,20 Z M 31,24L 31,55L 55,55L 55,37L 42,37L 42,24L 31,24 Z M 46,25.25L 46,33L 53.75,33L 46,25.25 Z"/></svg>',
	'leftPanelIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 57,19L 57,57L 19,57L 19,19L 57,19 Z M 22,54L 54,54L 54,22.0001L 22,22L 22,54 Z M 24,24.0001L 36,24.0001L 36,52L 24,52L 24,24.0001 Z M 52,36L 43.3334,36L 47,31.0001L 43,31L 38,38L 43,45L 47,45L 43.3334,40L 52,40L 52,36 Z"/></svg>',
	'rightPanelIcon' : '<svg height="16" width="16" preserveAspectRatio="xMinYMin slice" viewBox="0 0 76 76" style="-moz-transform: scale(2);-ms-transform: scale(2);-o-transform: scale(2);-webkit-transform: scale(2);transform: scale(2);">\t<path fill-opacity="1" stroke-width="0.2" stroke-linejoin="round" d="M 19,19L 19,57L 57,57L 57,19L 19,19 Z M 54,54L 22,54L 22,22.0001L 54,22L 54,54 Z M 52,24.0001L 41,24L 41,52L 52,52L 52,24.0001 Z M 24,36L 33.6666,36L 30,31.0001L 34,31L 39,38L 34,45L 30,45L 33.6666,40L 24,40L 24,36 Z"/></svg>',
};

Blade = function(options) {
	options.icons = {
		'close' : $.bladeIcons.closeIcon,
		'refresh' : $.bladeIcons.refreshIcon,
		'min' : $.bladeIcons.minIcon,
		'restore' : $.bladeIcons.restoreIcon,
		'max' : $.bladeIcons.maxIcon,
	};

	_registEvents = function() {
		blade.mousedown(function(e) {
			if (e.which == 3&&!$(".edit-layout").is(":visible")) {
				$(document).off();
				var ex = e || window.event;
				var txt = ex.target.innerText;
				var menu = $(".fxs-contextMenu");
				var context = ko.dataFor(menu[0]);
				if (context) {
					context.menuItems.removeAll();
				} else {
					context = {
						menuItems : ko.observableArray()
					};
					ko.applyBindings(context, menu[0]);
				}
//				context.menuItems.push({
//					icon : $.bladeIcons.editIcon,
//					text : '复制标签内容',
//					click : function() {
//						var clipboardData = window.clipboardData; //for IE  
//						if (!clipboardData) { // for chrome  
//							clipboardData = e.originalEvent.clipboardData;
//						}
//						//e.clipboardData.getData('text');//可以获取用户选中复制的数据  
//						clipboardData.setData('Text', txt);
//						alert(txt);
//					}
//				});
				//				context.menuItems.push({
				//					icon : $.bladeIcons.editIcon,
				//					text : '粘贴',
				//					click : function() {
				//						if(document.execCommand("paste", false, null)){
				//							alert("复制成功");
				//						}else{
				//							alert("浏览器不支持复制粘贴功能!");
				//						}
				//					}
				//				});
				var target = $(ex.target, e.currentTarget);
				var dataItem = target.hasClass("data-item") ? target : target.parents(".data-item");
				if (dataItem.length == 1) {
					var vm = ko.contextFor(dataItem.get(0));
					if (vm.$parent.itemEditClick) {
						$.gs.editItem(vm.$data);
						context.menuItems.push({
							icon : $.bladeIcons.editIcon,
							text : '编辑',
							click : vm.$parent.itemEditClick
						});
					}
				}
				var length = options.actionCommands().length;
				for (var i = 0; i < length; i++) {
					context.menuItems.push(options.actionCommands()[i]);
				}
				if (options.actionCommands().length > 0) {
					menu.animate({
						'left' : ex.clientX + 'px',
						'top' : ex.clientY + 'px'
					}, 50, "swing");
					menu.slideDown(50, function() {
						$(document).click(function() {
							menu.slideUp(50);
						});
					});
				}
			}
		});
		/***********************************************************************
		 * // min->restore $(".fxs-blade-header", blade).click(function() { var
		 * blade = $(this).parents('.fxs-blade.fxs-blade-minimized'); if
		 * (blade.length > 0) { var bladeContent = $('.fxs-bladecontent',
		 * blade); bladeContent.removeClass('fxs-blade-minimized');
		 * blade.removeClass('fxs-blade-minimized');
		 * $('.fxs-blade-maximizeOrRestore', blade).html(options.icons.restore);
		 * return false; } }); // Header MaxOrRestore $(".fxs-blade-hgroup",
		 * blade).dblclick(function() { var blade =
		 * $(this).parents('.fxs-blade'); $(".fxs-blade-maximizeOrRestore",
		 * blade).click(); });
		 **********************************************************************/
		// Header Drag
		$(".fxs-blade-hgroup", blade).mousedown(function(e) {
			var drag = true;
			var x = e.clientX;
			var content = $('.fxs-portal-content');

			$(document).off().on('mousemove', function(e) {
				if (drag) {
					var _x = e.clientX;
					var left = content.scrollLeft();
					content.scrollLeft(left + x - _x);
					x = _x;
				}
			});
			$(document).on('mouseup', function(e) {
				$(document).off();
				drag = false;
			});
		});
		// close
		$(".fxs-blade-close", blade).click(function() {
			var blade = $(this).parents('.fxs-blade');
			var preBlade = blade.prev();
			blade.remove();
			$.ensureElementIntoView(preBlade);
			return false;
		});
	/***********************************************************************
	 * // maximizeOrRestore $(".fxs-blade-maximizeOrRestore",
	 * blade).click(function() { if (options.state() == 'max') {
	 * options.state('restore'); } else { options.state('max'); }
	 * $.ensureElementIntoView(blade); return false; }); // minimize
	 * $(".fxs-blade-minimize", blade).click(function() {
	 * options.state('min'); return false; });
	 **********************************************************************/
	};

	var blade_tmp = $("#blade-template").html();
	var blade = $(blade_tmp);

	_registEvents();
	var length = blade.length;
	for (var i = 0; i < length; i++) {
		ko.applyBindings(options, blade[i]);
	}
	var content = $(".fxs-blade-content", blade);
	if (options.url()) {
		$.ajax({
			type : 'get',
			datatype : 'html',
			url : options.url(),
			success : function(data) {
				content.html(data);
			},
			error : function(data, errorCode) {
				content.html("错误信息：" + data + "<br/>错误代码：" + errorCode);
			}
		});
	}
	return blade;
};